#操作系统 
# [50] 初识文件管理
文件, 就是一组有意义的信息/数据集合。
![](img/01_prefix/02%20计算机系统架构与操作系统.jpg)

问题：
- 计算机中存放了各种各样的文件, 一个文件有哪些属性？ 
- **文件内部**的数据应该怎样组织起来？ 
- **文件之间**又应该又应该怎么组织起来？ 
站在操作系统的角度来看：
- 从下往上看, 操作系统应提供哪些功能, 才能方便用户、应用程序使用文件？ 
- 从上往下看, 文件数据应该怎么存放在外存(磁盘)上？

## 1.文件基本属性
- **文件名**：最基本的属性；由创建文件的用户决定文件名, 主要是为了方便用户找到文件, 同一目录下不允许有重名文件。
- **标识符**：一个系统内的各文件标识符唯一, 对用户来说毫无可读性, 因此标识符只是操作系统用于区分各个文件的一种内部名称。 
- **类型**：指明文件的类型。
- **位置**：文件存放的路径(让用户使用)、在外存中的地址(操作系统使用, 对用户不可见)。 
- **大小**：指明文件大小。
- **创建时间**、**上次修改时间**。
- **文件所有者信息**。 
- **保护信息**：对文件进行保护的访问控制信息。

![](img/04_file_mngmnt/01%20文件基本属性.jpg)


## 2.内部的数据应该怎样组织起来
- 无结构文件(如文本文件), 由一些二进制或字符流组成, 又称“**流式文件**(stream)”
- 有结构文件(如数据库表), 由一条一条记录组成, 对于每一条记录, 由各相关数据项组成。

## 3.文件间的数据应该怎样组织起来
用户可以自己创建一层一层的目录, 各层目录中存放相应的文件。系统中的各个文件就通过一层一层的目录合理有序的组织起来了, 目录其实也是一种特殊的有结构文件(由记录组成)。所谓的“目录” 其实就是我们熟悉的“文件夹”。

![](img/04_file_mngmnt/02-文件间组织关系.jpg)

## 4.操作系统应该向上提供哪些功能
- 创建文件(create 系统调用)
- 读文件(read 系统调用)
- 写文件(write 系统调用)
- 删除文件(delete 系统调用)
- 打开文件(open 系统调用)
- 关闭文件(close 系统调用)

可用几个基本操作完成更复杂的操作。  
比如：“复制文件”, 先创建一个新的空文件, 再把“源文件”读入内存, 再将内存中的数据写到新文件中。

## 5.从上往下看, 文件应如何存放在外存
操作系统以“块”为单位为文件分配存储空间, 因此即使一个文件大小只有10B, 但它依然需要占用 1KB 的磁盘块。外存中的数据读入内存时, 同样以块为单位。

![](img/04_file_mngmnt/03%20磁盘块.jpg)
类似于内存分为一个个“内存块”, 外存会分为一个个“块/磁盘块/物理块”。
每个磁盘块的大小是相等的, 每块一般包含2的整数幂个地址(如, 本例中, 一块包含2^10个地址, 即1KB)。同样类似的是, 文件的逻辑地址也可以分为(逻辑块号, 块内地址), 操作系统同样需要将逻辑地址转换为外存的物理地址(物理块号, 块内地址)的形式。块内地址的位数取决于磁盘块的大小。

文件数据放在离散的几个磁盘块中。此时, 应该如何记录各个磁盘块之间的先后顺序呢？这些需要后续的内容继续深入讨论。

# [51] 文件的逻辑结构
- “逻辑结构”，就是指在用户看来，文件内部的数据应该是如何组织起来的。
- “物理结构”，指的是在操作系统看来，文件的数据是如何存放在外存中的。

类似于数据结构的“逻辑结构”和“物理结构”。 
如“**线性表**”就是一种逻辑结构，在用户角度看来，线性表就是一组有先后关系的元素序列， “线性表”这种逻辑结构可以用不同的物理结构实现，如：顺序表，链表。
顺序表的各个元素在逻辑上相邻，在物理上也相邻；而链表的各个元素在物理上可以是不相邻的。因此，顺序表可以实现“随机访问”，而“链表”无法实现随机访问。可见，算法的具体实现与逻辑结构、物理结构都有关。

按文件是否有结构分类，可以分为无结构文件、有结构文件两种。 
## 1.无结构文件与有结构文件
- 无结构文件：
文件内部的数据就是一系列二进制流或字符流组成。又称“流式文件”。如：Windows 操作系统中的 .txt 文件。
- 有结构文件：
由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。如： 数据库表文件。一般来说，每条记录有一个数据项可作为关键字（作为识别不同记录的ID），根据各条记录的长度（占用的存储空间）是否相等，又可分为定长记录和可变长记录两种。

根据有结构文件中的各条记录在逻辑上如何组织，可以分为三类：
## 2.顺序文件
- 顺序文件：
文件中的记录一个接一个地顺序排列（逻辑上），记录可以是定长的或可变长的。各个记录在物理上可以顺序存储或链式存储。

## 3.索引文件
建立一张**索引表**以加快文件检索速度。每条记录对应一个索引项。

![](img/04_file_mngmnt/04%20索引表.jpg)

索引表本身是定长记录的顺序文件。因此可以快速找到第i个记录对应的索引项。可将关键字作为索引号内容，若按关键字顺序排列，则还可以支持按照关键字折半查找。 
每当要增加/删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合。
另外，可以用不同的数据项建立多个索引表。如：学生信息表中，可用关键字“学号”建立一张索引表。也可用“姓名”建立一张索引表。这样就 可以根据“姓名”快速地检索文件了。

## 4.索引顺序文件
索引顺序文件是索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立一张索引表，但不同的是：并不是每个记录对应一个索引表项，而是一组记录对应一个索引表项。

为了进一步提高检索效率，可以为顺序文件建立多级索引表。例如，对于一个含 106个记录的文件，可先 为该文件建立一张低级索引表，每 100 个记录为一组，故低级索引表中共有 10000 个表项（即10000个定长 记录），再把这 10000 个定长记录分组，每组100个，为其建立顶级索引表，故顶级索引表中共有 100 个表 项。

# [52] 文件目录
![](img/04_file_mngmnt/05%20文件路径.jpg)

## 1.文件控制块
FCB（file control block）， 实现了文件名和文件之间的映射。使用户（用户程序）可以实现“按名存取”。

FCB的有序集合即称为“**文件目录**”，一个FCB就是一个文件目录项。 FCB中包含了文件的基本信息（文件名、物理地址、逻辑结构、物理结构等），存取控制信息（是否可读/可写、禁止访问的用户名单等），使用信息（如文件的建立时间、修改时间等）。 最重要，最基本的还是文件名、文件存放的物理地址。

可以对目录进行哪些操作？ 
- 搜索：当用户要使用一个文件时，系统要根据文件名搜索目录，找到该文件对应的目录项 
- 创建文件：创建一个新文件时，需要在其所属的目录中增加一个目录项 
- 删除文件：当删除一个文件时，需要在目录中删除相应的目录项 
- 显示目录：用户可以请求显示目录的内容，如显示该目录中的所有文件及相应属性 
- 修改目录：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项（如：文件重命名）。

# [53] 文件保护

# [54] 文件共享

# [55] 文件实现(上)

# [56] 文件实现(下)

# [57] 逻辑结构V.S.物理结构

# [58] 文件存储空间管理

# [59] 文件的基本操作

# [60] 文件系统的层次结构